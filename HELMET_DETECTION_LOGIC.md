# å®‰å…¨å¸½æª¢æ¸¬é‚è¼¯èªªæ˜

## ğŸ“‹ æª¢æ¸¬è¦å‰‡

### 1. äººè‡‰å‰ç½®æ¢ä»¶
**å®‰å…¨å¸½æª¢æ¸¬åªåœ¨åµæ¸¬åˆ°äººè‡‰æ™‚æ‰æœƒé€²è¡Œ**

- âœ… æœ‰äººè‡‰æª¢æ¸¬çµæœ â†’ é€²è¡Œå®‰å…¨å¸½æª¢æ¸¬
- âŒ æ²’æœ‰äººè‡‰æª¢æ¸¬çµæœ â†’ è·³éå®‰å…¨å¸½æª¢æ¸¬

**åŸå› **: ç¢ºä¿å®‰å…¨å¸½é•è¦èƒ½å¤ é—œè¯åˆ°å…·é«”çš„äººå“¡ï¼Œæé«˜æª¢æ¸¬æº–ç¢ºæ€§ã€‚

### 2. 20ç§’é–“éš”æ§åˆ¶
**åŒä¸€äººå“¡çš„å®‰å…¨å¸½é•è¦è¨˜éŒ„é–“éš”ç‚º20ç§’**

- ç¬¬1æ¬¡æª¢æ¸¬åˆ°é•è¦ â†’ ç«‹å³è¨˜éŒ„ä¸¦æˆªåœ–
- 20ç§’å…§å†æ¬¡æª¢æ¸¬åˆ°åŒä¸€äººé•è¦ â†’ ä¸è¨˜éŒ„ã€ä¸æˆªåœ–
- 20ç§’å¾Œå†æ¬¡æª¢æ¸¬åˆ°åŒä¸€äººé•è¦ â†’ è¨˜éŒ„ä¸¦æˆªåœ–

**ç›®çš„**:
- é¿å…å°åŒä¸€äººç”¢ç”Ÿéå¤šé‡è¤‡è¨˜éŒ„
- é™ä½å„²å­˜ç©ºé–“å’Œé€šçŸ¥é »ç‡
- ä¿æŒåˆç†çš„é•è¦è¿½è¹¤

## ğŸ”§ æŠ€è¡“å¯¦ä½œ

### æª¢æ¸¬æµç¨‹

```
1. æ¥æ”¶å½±åƒå¹€
   â†“
2. æª¢æŸ¥æ˜¯å¦æœ‰äººè‡‰æª¢æ¸¬çµæœ
   â†“ æœ‰              â†“ æ²’æœ‰
3a. é€²è¡Œå®‰å…¨å¸½æª¢æ¸¬    3b. è·³éæª¢æ¸¬ï¼Œè¿”å›ç©ºçµæœ
   â†“
4. å°‡é•è¦èˆ‡äººè‡‰é—œè¯
   â†“
5. æª¢æŸ¥æ˜¯å¦è¶…é20ç§’é–“éš”
   â†“ æ˜¯              â†“ å¦
6a. è¨˜éŒ„+æˆªåœ–+é€šçŸ¥    6b. åƒ…è¨˜éŒ„ï¼ˆä¸æˆªåœ–/é€šçŸ¥ï¼‰
```

### äººè‡‰é—œè¯é‚è¼¯

```python
def _associate_violation_with_person(violation, face_detections):
    """
    è¨ˆç®—é•è¦æ¡†èˆ‡äººè‡‰æ¡†çš„é‡ç–Šåº¦
    é‡ç–Šåº¦é–¾å€¼: 30%
    """
    for face in face_detections:
        overlap_ratio = calculate_overlap(violation.bbox, face.bbox)
        if overlap_ratio > 0.3:
            return face.person_id

    return None  # æ²’æœ‰è¶³å¤ é‡ç–Šçš„äººè‡‰
```

### é–“éš”æ§åˆ¶é‚è¼¯

```python
def _should_take_screenshot(person_id, current_time):
    """
    æª¢æŸ¥æ˜¯å¦æ‡‰è©²æˆªåœ–
    """
    last_time = last_screenshot_time.get(person_id)

    if last_time is None:
        return True  # ç¬¬ä¸€æ¬¡æª¢æ¸¬

    time_diff = current_time - last_time
    return time_diff.total_seconds() >= 20  # 20ç§’é–“éš”
```

## ğŸ“Š ç¯„ä¾‹æƒ…å¢ƒ

### æƒ…å¢ƒ1: å–®äººé•è¦

```
æ™‚é–“è»¸:
00:00 - æª¢æ¸¬åˆ°äººè‡‰A + æœªæˆ´å®‰å…¨å¸½ â†’ âœ… è¨˜éŒ„+æˆªåœ–
00:05 - æª¢æ¸¬åˆ°äººè‡‰A + æœªæˆ´å®‰å…¨å¸½ â†’ â­ï¸ è·³éï¼ˆæœªæ»¿20ç§’ï¼‰
00:15 - æª¢æ¸¬åˆ°äººè‡‰A + æœªæˆ´å®‰å…¨å¸½ â†’ â­ï¸ è·³éï¼ˆæœªæ»¿20ç§’ï¼‰
00:21 - æª¢æ¸¬åˆ°äººè‡‰A + æœªæˆ´å®‰å…¨å¸½ â†’ âœ… è¨˜éŒ„+æˆªåœ–ï¼ˆå·²æ»¿20ç§’ï¼‰
```

### æƒ…å¢ƒ2: å¤šäººé•è¦

```
æ™‚é–“è»¸:
00:00 - æª¢æ¸¬åˆ°äººè‡‰A + æœªæˆ´å®‰å…¨å¸½ â†’ âœ… è¨˜éŒ„A+æˆªåœ–
00:00 - æª¢æ¸¬åˆ°äººè‡‰B + æœªæˆ´å®‰å…¨å¸½ â†’ âœ… è¨˜éŒ„B+æˆªåœ–
00:10 - æª¢æ¸¬åˆ°äººè‡‰A + æœªæˆ´å®‰å…¨å¸½ â†’ â­ï¸ è·³éAï¼ˆæœªæ»¿20ç§’ï¼‰
00:10 - æª¢æ¸¬åˆ°äººè‡‰B + æœªæˆ´å®‰å…¨å¸½ â†’ â­ï¸ è·³éBï¼ˆæœªæ»¿20ç§’ï¼‰
00:25 - æª¢æ¸¬åˆ°äººè‡‰A + æœªæˆ´å®‰å…¨å¸½ â†’ âœ… è¨˜éŒ„A+æˆªåœ–ï¼ˆAå·²æ»¿20ç§’ï¼‰
00:25 - æª¢æ¸¬åˆ°äººè‡‰B + æœªæˆ´å®‰å…¨å¸½ â†’ âœ… è¨˜éŒ„B+æˆªåœ–ï¼ˆBå·²æ»¿20ç§’ï¼‰
```

**èªªæ˜**: æ¯å€‹äººå“¡ç¨ç«‹è¿½è¹¤é–“éš”æ™‚é–“

### æƒ…å¢ƒ3: æ²’æœ‰äººè‡‰

```
æ™‚é–“è»¸:
00:00 - æœªæª¢æ¸¬åˆ°äººè‡‰ï¼Œæª¢æ¸¬åˆ°å®‰å…¨å¸½é•è¦ â†’ âŒ å®Œå…¨è·³é
00:05 - æª¢æ¸¬åˆ°äººè‡‰Aï¼Œæª¢æ¸¬åˆ°å®‰å…¨å¸½é•è¦ â†’ âœ… è¨˜éŒ„+æˆªåœ–
```

## ğŸ¯ é…ç½®åƒæ•¸

### é–“éš”æ™‚é–“èª¿æ•´

åœ¨ `src/monitoring_system.py` ä¸­:

```python
self.helmet_violation_manager = HelmetViolationManager(
    helmet_detector=self.helmet_detector,
    notification_sender=self.notification_sender,
    screenshot_manager=self.screenshot_manager,
    screenshot_interval=20  # èª¿æ•´é€™å€‹å€¼ï¼ˆç§’ï¼‰
)
```

### é‡ç–Šåº¦é–¾å€¼èª¿æ•´

åœ¨ `src/managers/helmet_violation_manager.py` ä¸­:

```python
def _associate_violation_with_person(self, violation, face_detections):
    # ...
    if best_overlap > 0.3:  # èª¿æ•´é€™å€‹é–¾å€¼ (0.0 - 1.0)
        return best_person_id
```

**å»ºè­°å€¼**:
- `0.2` - è¼ƒå¯¬é¬†ï¼Œå¯èƒ½é—œè¯åˆ°è¼ƒé çš„äººè‡‰
- `0.3` - é è¨­å€¼ï¼Œå¹³è¡¡æº–ç¢ºæ€§
- `0.5` - è¼ƒåš´æ ¼ï¼Œè¦æ±‚é•è¦èˆ‡äººè‡‰æœ‰æ˜é¡¯é‡ç–Š

## ğŸ“ˆ çµ±è¨ˆè³‡è¨Š

å¯ä»¥é€éAPIæŸ¥è©¢çµ±è¨ˆè³‡è¨Š:

```python
stats = helmet_violation_manager.get_stats()

# å›å‚³å…§å®¹:
{
    "total_violations": 150,        # ç¸½é•è¦æ¬¡æ•¸
    "screenshots_taken": 45,        # å¯¦éš›æˆªåœ–æ¬¡æ•¸
    "unique_violators": 12,         # å”¯ä¸€é•è¦äººå“¡æ•¸
    "screenshot_interval_seconds": 20,
    "known_violators": 12,          # å·²çŸ¥é•è¦äººå“¡æ•¸
    "runtime_hours": 2.5
}
```

## ğŸ§ª æ¸¬è©¦

åŸ·è¡Œæ¸¬è©¦è…³æœ¬é©—è­‰é‚è¼¯:

```bash
python test_helmet_detection_with_face.py
```

æ¸¬è©¦é …ç›®:
1. âœ… æ²’æœ‰äººè‡‰æ™‚ä¸æª¢æ¸¬
2. âœ… æœ‰äººè‡‰æ™‚é€²è¡Œæª¢æ¸¬
3. âœ… 20ç§’é–“éš”æ§åˆ¶
4. âœ… å¤šäººç¨ç«‹è¿½è¹¤

## ğŸ’¡ æœ€ä½³å¯¦è¸

### 1. äººè‡‰è­˜åˆ¥æº–ç¢ºæ€§
- ç¢ºä¿æ”å½±æ©Ÿè§’åº¦èƒ½æ¸…æ¥šæ‹åˆ°äººè‡‰
- é©ç•¶çš„å…‰ç·šæ¢ä»¶
- äººå“¡ä¸è¦æˆ´å£ç½©æˆ–é®æ“‹è‡‰éƒ¨

### 2. é–“éš”æ™‚é–“è¨­å®š
- **5-10ç§’**: é«˜é »ç‡ç›£æ§ï¼Œé©åˆé«˜é¢¨éšªå€åŸŸ
- **20ç§’**: é è¨­å€¼ï¼Œå¹³è¡¡ç›£æ§å’Œå„²å­˜
- **30-60ç§’**: ä½é »ç‡ç›£æ§ï¼Œé©åˆä¸€èˆ¬å€åŸŸ

### 3. å„²å­˜ç®¡ç†
```python
# å®šæœŸæ¸…ç†èˆŠè¨˜éŒ„
manager.cleanup_old_records(days=30)

# é‡ç½®ç‰¹å®šäººå“¡çš„é–“éš”
manager.reset_screenshot_history(person_id="person_001")

# é‡ç½®æ‰€æœ‰äººå“¡çš„é–“éš”
manager.reset_screenshot_history()
```

## ğŸ”„ èˆ‡Rule Engineæ•´åˆ

Rule Engineå¯ä»¥é€²ä¸€æ­¥æ§åˆ¶æª¢æ¸¬è¡Œç‚º:

```json
{
  "rule_id": "helmet_rule_001",
  "detection_types": ["helmet"],
  "stream_source_ids": ["camera_001"],
  "person_ids": null,  // æ‰€æœ‰äººå“¡
  "confidence_threshold": 0.75,
  "schedule_enabled": true,
  "schedule_config": {
    "weekdays": [1, 2, 3, 4, 5],  // é€±ä¸€åˆ°é€±äº”
    "time_ranges": [
      {"start": "08:00", "end": "17:00"}  // ä¸Šç­æ™‚é–“
    ]
  }
}
```

## ğŸ“ ç›¸é—œæª”æ¡ˆ

- å¯¦ä½œ: `src/managers/helmet_violation_manager.py`
- ç›£æ§ç³»çµ±æ•´åˆ: `src/monitoring_system.py`
- æ¸¬è©¦: `test_helmet_detection_with_face.py`
- é–“éš”æ¸¬è©¦: `test_helmet_interval.py`

## âš™ï¸ æŠ€è¡“ç´°ç¯€

### åŸ·è¡Œç·’å®‰å…¨
- ä½¿ç”¨ `threading.Lock` ä¿è­·å…±äº«è³‡æ–™
- å¤šæ”å½±æ©Ÿä¸¦è¡Œè™•ç†æ™‚çš„è³‡æ–™ä¸€è‡´æ€§

### è¨˜æ†¶é«”ç®¡ç†
- é•è¦è¨˜éŒ„é™åˆ¶åœ¨1000ç­†ï¼ˆè¨˜æ†¶é«”ä¸­ï¼‰
- è¶…éå¾Œè‡ªå‹•ä¿ç•™æœ€è¿‘500ç­†
- å®Œæ•´è¨˜éŒ„å„²å­˜åœ¨æª”æ¡ˆç³»çµ±

### æª”æ¡ˆçµ„ç¹”
```
data/helmet_violations/
â”œâ”€â”€ violations_2024-10-01.json
â”œâ”€â”€ violations_2024-10-02.json
â””â”€â”€ violations_2024-10-03.json
```

æ¯å¤©ä¸€å€‹æª”æ¡ˆï¼Œæ–¹ä¾¿ç®¡ç†å’ŒæŸ¥è©¢ã€‚

---

**ç‰ˆæœ¬**: 1.0.0
**æœ€å¾Œæ›´æ–°**: 2025-10-02
**é–“éš”æ™‚é–“**: 20ç§’
**äººè‡‰å‰ç½®æ¢ä»¶**: å¿…é ˆ
