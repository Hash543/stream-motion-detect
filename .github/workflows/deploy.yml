name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H 210.61.69.175 >> ~/.ssh/known_hosts

      - name: Test SSH Connection
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ysapi_backup@210.61.69.175 'echo "SSH connection successful"'

      - name: Pull latest code from Git
        run: |
          ssh -i ~/.ssh/deploy_key ysapi_backup@210.61.69.175 << 'ENDSSH'
            cd ~/stream-motion-detect

            echo "ğŸ“¦ Backing up .env file..."
            if [ -f .env ]; then
              cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
              echo "âœ… .env backed up"
            fi

            echo "ğŸ”„ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            echo "âœ… Code updated to latest commit:"
            git log -1 --oneline

            echo "ğŸ“ Restoring .env file..."
            # æ¢å¾©æœ€æ–°çš„å‚™ä»½
            LATEST_BACKUP=$(ls -t .env.backup.* 2>/dev/null | head -1)
            if [ -n "$LATEST_BACKUP" ]; then
              cp "$LATEST_BACKUP" .env
              echo "âœ… .env restored from $LATEST_BACKUP"
            elif [ ! -f .env ]; then
              # å¦‚æœæ²’æœ‰å‚™ä»½ä¸”æ²’æœ‰ .envï¼Œå‰µå»ºé è¨­é…ç½®
              echo "POSTGRES_HOST=db" > .env
              echo "POSTGRES_PORT=5432" >> .env
              echo "POSTGRES_DATABASE=motion-detector" >> .env
              echo "POSTGRES_USER=face-motion" >> .env
              echo "POSTGRES_PASSWORD=kkk12345" >> .env
              echo "SESSION_SECRET=your-secret-key-change-this-in-production" >> .env
              echo "LOG_LEVEL=INFO" >> .env
              echo "TZ=Asia/Taipei" >> .env
              echo "âœ… .env created with default settings"
            fi

            # å»ºç«‹å¿…è¦ç›®éŒ„
            mkdir -p config screenshots logs data models
          ENDSSH

      - name: Deploy with Docker Compose
        run: |
          ssh -i ~/.ssh/deploy_key ysapi_backup@210.61.69.175 << 'ENDSSH'
            eval "$(/opt/homebrew/bin/brew shellenv)"
            cd ~/stream-motion-detect

            echo "ğŸ›‘ Stopping existing containers..."
            docker compose down

            echo "ğŸ”¨ Building and starting new containers..."
            docker compose up -d --build

            echo "â³ Waiting for services to be healthy..."
            sleep 10

            echo "ğŸ“Š Checking service status..."
            docker compose ps
          ENDSSH

      - name: Verify deployment
        run: |
          echo "Waiting for API to be ready..."
          sleep 5

          # æª¢æŸ¥ API å¥åº·ç‹€æ…‹
          HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://detection-api.wyattst.net/api/health)

          if [ "$HEALTH_STATUS" = "200" ]; then
            echo "âœ… Deployment successful! API is healthy."
          else
            echo "âŒ Deployment failed! API health check returned: $HEALTH_STATUS"
            exit 1
          fi

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

      - name: Send deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "ğŸš€ Deployment to production completed successfully!"
          else
            echo "âŒ Deployment to production failed!"
          fi
